<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Database Management - Calibration Service Documentation</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Calibration Service Documentation</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href=".." class="nav-link">Welcome to MkDocs</a>
                            </li>
                            <li class="nav-item">
                                <a href="../ARCHITECTURE/" class="nav-link">ARCHITECTURE</a>
                            </li>
                            <li class="nav-item">
                                <a href="./" class="nav-link active" aria-current="page">Database Management</a>
                            </li>
                            <li class="nav-item">
                                <a href="../DEVELOPER/" class="nav-link">Developer Guide</a>
                            </li>
                            <li class="nav-item">
                                <a href="../PROJECT/" class="nav-link">Senior Backend Engineer - ISW | Take Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../TESTS/" class="nav-link">Testing Strategy for Calibration Service</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../ARCHITECTURE/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../DEVELOPER/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#database-management" class="nav-link">Database Management</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#overview" class="nav-link">Overview</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#directory-structure" class="nav-link">Directory Structure</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#common-operations" class="nav-link">Common Operations</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#migration-management" class="nav-link">Migration Management</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#best-practices" class="nav-link">Best Practices</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#environment-configuration" class="nav-link">Environment Configuration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#troubleshooting" class="nav-link">Troubleshooting</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="database-management">Database Management</h1>
<p>This document covers database management, migrations, and best practices for this project.</p>
<h2 id="overview">Overview</h2>
<p>The project uses:</p>
<ul>
<li>PostgreSQL as the database</li>
<li>SQLAlchemy for ORM and database operations</li>
<li>Alembic for database migrations</li>
<li>Automatic migration generation from SQLAlchemy models</li>
</ul>
<h2 id="directory-structure">Directory Structure</h2>
<pre><code>src/
├── infrastructure/
│   └── orm_models.py    # SQLAlchemy models
├── config/
│   └── database.py      # Database configuration
└── alembic/
    ├── versions/        # Migration version files
    ├── env.py          # Migration environment configuration
    └── script.py.mako  # Migration script template
</code></pre>
<h2 id="common-operations">Common Operations</h2>
<p>The project provides several commands for database management:</p>
<pre><code class="language-bash"># Initialize database and run migrations
uv run db_init

# Create a new migration after model changes
uv run db_create &quot;Description of changes&quot;

# Apply pending migrations
uv run db_migrate
</code></pre>
<h2 id="migration-management">Migration Management</h2>
<h3 id="creating-migrations">Creating Migrations</h3>
<p>When you modify SQLAlchemy models in <code>orm_models.py</code>, create a new migration:</p>
<pre><code class="language-bash">uv run db_create &quot;Add status column to Calibration model&quot;
</code></pre>
<p>Always:</p>
<ol>
<li>Review the generated migration in <code>alembic/versions/</code></li>
<li>Check indexes and constraints</li>
<li>Add any necessary data migrations</li>
<li>Run tests before committing</li>
</ol>
<h3 id="applying-migrations">Applying Migrations</h3>
<p>To apply pending migrations:</p>
<pre><code class="language-bash"># Development environment
uv run db_migrate

# Test environment
PYTHON_ENV=test uv run db_migrate

# Production environment
PYTHON_ENV=production uv run db_migrate
</code></pre>
<h3 id="advanced-operations">Advanced Operations</h3>
<p>For advanced cases, you can use direct Alembic commands:</p>
<pre><code class="language-bash"># Roll back one migration
PYTHONPATH=./src alembic downgrade -1

# View migration history
PYTHONPATH=./src alembic history --verbose

# Roll back to specific version
PYTHONPATH=./src alembic downgrade &lt;version_id&gt;
</code></pre>
<h2 id="best-practices">Best Practices</h2>
<h3 id="1-migration-management">1. Migration Management</h3>
<ul>
<li>One migration per model change</li>
<li>Write descriptive migration messages</li>
<li>Include model name in migration message</li>
<li>Review generated migrations before committing</li>
<li>Test both upgrade and downgrade paths</li>
</ul>
<h3 id="2-data-safety">2. Data Safety</h3>
<ul>
<li>Always backup production data before migrations</li>
<li>Test migrations on development first</li>
<li>Include data migrations when needed</li>
<li>Verify data integrity after migration</li>
</ul>
<h3 id="3-development-workflow">3. Development Workflow</h3>
<ul>
<li>Create migrations in feature branches</li>
<li>Run full test suite after migrations</li>
<li>Document significant migrations</li>
<li>Use appropriate environment for testing</li>
</ul>
<h3 id="4-error-handling">4. Error Handling</h3>
<ul>
<li>Never edit committed migrations</li>
<li>Create new migrations for fixes</li>
<li>Roll back failed migrations cleanly</li>
<li>Check database state before retrying</li>
</ul>
<h2 id="environment-configuration">Environment Configuration</h2>
<p>The database system uses the project's layered environment configuration:</p>
<ol>
<li><code>.env</code> - Base defaults (in git)</li>
<li><code>.env.local</code> - Local overrides (git-ignored)</li>
<li><code>.env.{ENV}</code> - Environment specific (in git)</li>
<li><code>.env.{ENV}.local</code> - Environment specific local overrides (git-ignored)</li>
</ol>
<p>Example configurations:</p>
<pre><code class="language-bash"># .env (base defaults)
DATABASE_URL=postgresql+asyncpg://dev-user:password@localhost:5432/dev_db

# .env.test
DATABASE_URL=postgresql+asyncpg://test-user:password@localhost:5432/test_db

# .env.production
DATABASE_URL=postgresql+asyncpg://app-user:password@db.example.com:5432/prod_db
</code></pre>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="1-migration-not-detected">1. Migration Not Detected</h3>
<ul>
<li>Ensure model is imported in <code>orm_models.py</code></li>
<li>Verify model inherits from <code>Base</code></li>
<li>Check for circular imports</li>
<li>Run with <code>--verbose</code> flag for more details</li>
</ul>
<h3 id="2-connection-issues">2. Connection Issues</h3>
<pre><code class="language-bash"># Verify database is running
docker compose ps

# Check connection
uv run db_init

# Reset database (development only)
docker compose down -v postgres
uv run db_init
</code></pre>
<h3 id="3-migration-conflicts">3. Migration Conflicts</h3>
<ul>
<li>Never edit committed migrations</li>
<li>Create new migrations for fixes</li>
<li>Use <code>alembic history</code> to check state</li>
<li>Consider rolling back if needed</li>
</ul>
<h3 id="4-environment-issues">4. Environment Issues</h3>
<pre><code class="language-bash"># Check current settings
cat .env
cat .env.local  # If it exists

# Verify environment
echo $PYTHON_ENV
echo $DATABASE_URL
</code></pre>
<p>For more information about development workflows, see <a href="../DEVELOPER/">DEVELOPER.md</a>.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
