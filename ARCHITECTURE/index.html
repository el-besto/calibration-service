<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Architecture - Calibration Service Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Architecture";
        var mkdocs_page_input_path = "ARCHITECTURE.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Calibration Service Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../PROJECT/">Project</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Architecture</a>
    <ul class="current">
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../DEVELOPER/">DEVELOPER</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Calibration Service Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Architecture</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="grounding-inspiration">Grounding &amp; Inspiration</h2>
<p>This project uses Clean Architecture patterns. Hereafter "CA" will be used for "Clean Architecture".</p>
<ul>
<li>Background article by Bob Martin https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html</li>
<li>Diagrams<ul>
<li><a href="https://blog.cleancoder.com/uncle-bob/images/2012-08-13-the-clean-architecture/CleanArchitecture.jpg">The CA Diagram (sphere) - by Uncle Bob</a> -
  by Uncle Bob</li>
<li><a href="https://github.com/nikolovlazar/nextjs-clean-architecture/blob/main/assets/clean-architecture-diagram.jpg?raw=true">The CA Diagram (simplified) - by nikolovlazar</a></li>
</ul>
</li>
<li>Inspiration from existing CA implementations<ul>
<li><a href="https://medium.com/@shaliamekh/clean-architecture-with-python-d62712fd8d4f">CA with Python</a> - by R. Shaliamekh.<ul>
<li><a href="https://github.com/shaliamekh/clean-architecture-fastapi/tree/main">clean-architecture-fastapi - by shaliamekh</a> -
  associated repo for blog post</li>
</ul>
</li>
<li><a href="https://img.youtube.com/vi/jJVAla0dWJo/0.jpg">CA in Next.js</a>](https://www.youtube.com/watch?v=jJVAla0dWJo) -
  video describing CA<ul>
<li><a href="https://github.com/nikolovlazar/nextjs-clean-architecture/tree/main">nextjs-clean-architecture - by nikolovlazar</a> -
  associated repo for video</li>
</ul>
</li>
</ul>
</li>
<li>Other similar architectures to Clean Architecture<ul>
<li><a href="https://alistair.cockburn.us/hexagonal-architecture/">Hexagonal Architecture</a> - (a.k.a. Ports and Adapters) by
  Alistair Cockburn</li>
<li><a href="https://jeffreypalermo.com/2008/07/the-onion-architecture-part-1/">Onion Architecture</a> - by Jeffrey Palermo</li>
<li><a href="https://blog.cleancoder.com/uncle-bob/2011/09/30/Screaming-Architecture.html">Screaming Architecture</a> - by Uncle
  Bob (the same guy behind Clean Architecture)</li>
</ul>
</li>
</ul>
<h2 id="ca-in-brief">CA in brief</h2>
<p>Clean Architecture is a <em>set of rules</em> that help us structure our applications
in such way that they're easier to maintain and test, and their codebases are
predictable. It's like a common language that developers understand, regardless
of their technical backgrounds and programming language preferences.</p>
<p>Clean Architecture, and similar/derived architectures, all have the same goal -
<em>separation of concerns</em>. They introduce <strong>layers</strong> that bundle similar code
together. The "layering" helps us achieve important aspects in our codebase:</p>
<ul>
<li><strong>Independent of UI</strong> - the business logic is not coupled with the UI
  framework that's being used (in this case Next.js). The same system can be
  used in a CLI application, without having to change the business logic or
  rules.</li>
<li><strong>Independent of Database</strong> - the database implementation/operations are
  isolated in their own layer, so the rest of the app does not care about which
  database is being used, but communicates using <em>Models</em>.</li>
<li><strong>Independent of Frameworks</strong> - the business rules and logic simply don't know
  anything about the outside world. They receive data defined with plain
  objects/dictionaries, <em>Services</em> and <em>Repositories</em> to define
  their own logic and functionality. This allows us to use frameworks as tools,
  instead of having to "mold" our system into their implementations and
  limitations. If we use Route Handlers in our app's <em>Drivers</em>, and want to refactor some of
  them to use a different framework implementation all we need to do is just invoke the specific
  <em>controllers</em> in the new framework's manner, but the <em>core</em>
  business logic remains unchanged.</li>
<li><strong>Testable</strong> - the business logic and rules can easily be tested because it
  does not depend on the UI framework, or the database, or the web server, or
  any other external element that builds up our system.</li>
</ul>
<p>Clean Architecture achieves this through defining a <em>dependency hierarchy</em> -
layers depend only on layers <strong>below them</strong>, but not above.</p>
<h2 id="project-structure-only-the-important-parts">Project structure (only the important parts)</h2>
<ul>
<li><code>app</code> - <strong>Frameworks &amp; Drivers Layer</strong> - basically everything Next.js (pages,
  server actions, components, styles etc...) or whatever "consumes" the app's
  logic</li>
<li>~~<code>di</code> - Dependency Injection - a folder where we setup the DI container and the
  modules~~ # TODO: (future implementation)</li>
<li>~~<code>db</code> - Everything DB - initializing the DB client, defining schema, migrations~~ # TODO: (future implementation)</li>
<li><code>src</code> - The "root" of the system<ul>
<li><code>application</code> - <strong>Application Layer</strong> - holds use cases and interfaces for repositories and services</li>
<li><code>entities</code> - <strong>Entities Layer</strong> - holds models, value objects and custom errors/exceptions</li>
<li><code>infrastructure</code> - <strong>Infrastructure Layer</strong> - holds implementations of repositories and services,
  and pulls in the interfaces from <code>application</code></li>
<li><code>interface-adapters</code> - <strong>Interface Adapters Layer</strong> - holds controllers that serve as an entry point to the system
  (used in Frameworks &amp; Drivers layer to interact with the system)</li>
<li><code>drivers</code> - <strong>Frameworks &amp; Drivers layer</strong> - holds implementation-specific details for a given framework (e.g.
  FastAPI routes)</li>
</ul>
</li>
<li><code>tests</code> - Unit tests live here - the <code>unit</code> subfolder's structure matches <code>src</code></li>
<li><code>pyproject.toml</code> - list of deps &amp; configuration for python tools (linters, formatters, )<ul>
<li>~~Where the <code>pylint-module-boundaries</code> plugin is defined - <em>this stops you from breaking the dependency rule</em>~~ #
  TODO: (future implementation)</li>
</ul>
</li>
<li><code>scripts</code> - manual scripts to run project-wide actions (e.g. run tests) from bash terminal</li>
<li><code>docs</code> - project documentation</li>
<li><code>.github/workflows</code> - project cicd files</li>
</ul>
<h3 id="project-structure-developer-tooling">Project structure (Developer Tooling)</h3>
<ul>
<li><code>.pre-commit-config.yaml</code> - rules triggered to run via got hooks</li>
<li><code>cspell.config.yaml</code> - custom dictionary to keep IDE's inspection pane "clean"</li>
<li><code>.run</code> - shared run configurations for JetBrains PyCharm IDE</li>
</ul>
<h2 id="layers-explanation">Layers explanation</h2>
<ul>
<li><strong>Frameworks &amp; Drivers</strong>: keeps all the UI framework functionality, and
  everything else that interacts with the system (eg AWS Lambdas, Stripe
  webhooks etc...). In this scenario, that's FastAPI Route Handlers<ul>
<li>This layer should only use <em>Controllers</em>, <em>Models</em>, and <em>Errors</em>, and
  <strong>must not</strong> import <em>Use Cases</em>, <em>Repositories</em>, and <em>Services</em>.</li>
</ul>
</li>
<li><strong>Interface Adapters</strong>: defines <em>Controllers</em> and <em>Presenters</em>:<ul>
<li>Controllers perform <strong>authentication checks</strong> and <strong>input validation</strong>
  before passing the input to the specific use cases.</li>
<li>Controllers <em>orchestrate</em> Use Cases. They don't implement any logic, but
  define the whole operations using the use cases. In short, they use <em>"Use Case"</em> input ports.</li>
<li>Errors from deeper layers are bubbled up and being handled where controllers
  are being used.</li>
<li>Controllers use <em>Presenters</em> to convert the data to a UI-friendly format
  just before returning it to the "consumer". This helps
  prevent leaking any sensitive properties, like emails or hashed passwords,
  and also helps us slim down the amount of data we're sending back to the
  client. In short, they implement <em>Use Case</em> output ports.</li>
</ul>
</li>
<li><strong>Application</strong>: where the business logic lives. Sometimes called <em>core</em>. This
  layer defines the Use Cases and interfaces for the services and repositories.<ul>
<li><strong>Use Cases</strong>:<ul>
<li>Represent individual operations, like "Create Calibration" or "Sign In"</li>
<li>Accept pre-validated input (from controllers) and <em>handle authorization checks</em>.</li>
<li>Use <em>Repositories</em> and <em>Services</em> to access data sources and communicate
  with external systems.</li>
<li><strong>Use cases should not use other use cases</strong>. That's a code smell. It
  means the use case does multiple things and should be broken down into
  multiple use cases.</li>
</ul>
</li>
<li>Interfaces for Repositories and Services:<ul>
<li>These are defined in this layer because we want to break out the
  dependency of their tools and frameworks (database drivers, email services
  etc...), so we'll implement them in the <em>Infrastructure</em> layer.</li>
<li>Since the interfaces live in this layer, use cases (and transitively the
  upper layers) can access them through <em>Dependency Injection</em>.</li>
<li><em>Dependency Injection</em> allows us to split up the <strong>definitions</strong>
  (interfaces) from the <strong>implementations</strong> (classes) and keep them in a
  separate layer (infrastructure), but still allow their usage.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Entities</strong>: where the <em>Models</em> and <em>Exceptions</em> are defined.<ul>
<li><strong>Models</strong>:<ul>
<li>Define "domain" data shapes with plain JavaScript, without using
  "database" technologies.</li>
<li>Models are not always tied to the database - sending emails require an
  external email service, not a database, but we still need to have a data
  shape that will help other layers communicate "sending an email".</li>
<li>Models also define their own validation rules, which are called
  "Enterprise Business Rules". Rules that don't usually change, or are least
  likely to change when something <em>external</em> changes (page navigation,
  security, etc...). An example is a <code>User</code> model that defines a username
  field that must be <em>at least 6 characters long and not include special
  characters</em>.</li>
</ul>
</li>
<li><strong>Exceptions</strong>:<ul>
<li>We want our own errors because we don't want to be bubbling up
  database-specific errors, or any type of errors that are specific to a
  library or framework.</li>
<li>We <code>catch</code> errors that are coming from other libraries (for example
  SQAlchemy), and convert those errors to our own errors.</li>
<li>That's how we can keep our <em>core</em> independent of any frameworks,
  libraries, and technologies - one of the most important aspects of Clean
  Architecture.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Infrastructure</strong>: where <em>Repositories</em> and <em>Services</em> are being defined.<ul>
<li>This layer pulls in the interfaces of repositories and services from the
  <em>Application Layer</em> and implements them in their own classes.</li>
<li><em>Repositories</em> are how we implement the database operations. They are
  classes that expose methods that perform a single database operation - like
  <code>get_calibration</code>, or <code>create_calibration</code>, or <code>update_calibration</code>. This means that we use the
  database library / driver in these classes only. They don't perform any data
  validation, just execute queries and mutations against the database and
  either throw our custom defined <em>Errors</em> or return results.</li>
<li><em>Services</em> are shared services that are being used across the application -
  like an authentication service, or email service, or implement external
  systems like Stripe (create payments, validate receipts etc...). These
  services also use and depend on other frameworks and libraries. That's why
  their implementation is kept here alongside the repositories.</li>
<li>~~Since we don't want any layer to depend on this one (and transitively depend
  on the database and all the services), we use the
  <a href="https://en.wikipedia.org/wiki/Dependency_inversion_principle"><em>Dependency Inversion principle</em></a>.
  This allows us to depend only on the interfaces defined in the <em>Application
  Layer</em>, instead of the implementations in the <em>Infrastructure Layer</em>. We use
  an <a href="https://en.wikipedia.org/wiki/Inversion_of_control"><em>Inversion of Control</em></a>
  library like <a href="https://github.com/Evyweb/ioctopus">ioctopus</a> to abstract the
  implementation behind the interfaces and "inject" it whenever we need it. We
  create the abstraction in the <code>di</code> directory. We "bind" the repositories,
  services, controllers, and use cases to Symbols, and we "resolve" them using
  those symbols when we need the actual implementation. That's how we can use
  the implementation, without needing to explicitly depend on it (import it).~~ # TODO: future implementation</li>
</ul>
</li>
</ul>
<h3 id="folder-hierarchy-with-descriptions">Folder hierarchy with descriptions</h3>
<pre><code class="language-text">src/
├── config/                  # singleton configuration
│   ├── database.py             # returns SQLAlchemy SessionLocal instance or Engine
│   └── environment.py          # loads env variables, etc.
├── entities/                # &quot;Entities&quot; or &quot;core&quot; layer
│   ├── exceptions.py           # Core &quot;custom&quot; exceptions, decorates base exception w/&quot;cause&quot; and &quot;messages&quot;
│   ├── models/
│   └── value_objects/
├── application/             # &quot;Application&quot; layer
│   ├── repositories/           # (interfaces only)
│   ├── services/               # (interfaces only)
│   └── use_cases/              # implementation of CA &quot;Use Cases&quot;
│       └── exceptions.py          # exceptions that are specific to a given &quot;Use Case&quot;
├── interface_adapters/      # &quot;Interface&quot; adapters layer from CA
│   ├── controllers/            # &quot;Controllers&quot; from CA
│   └── presenters/             # &quot;Presenters&quot; from CA
├── drivers/                 # &quot;Frameworks &amp; Drivers&quot; layer
│   └── rest/                     # FastAPI framework
│       ├── routers/              # FastAPI request handlers
│       ├── schemas/              # FastAPI input and output schemas
│       ├── dependencies.py       # FastAPI middleware
│       ├── exception_handlers.py # FastAPI exception wrappers
│       └── main.py               # FastAPI entrypoint
└── infrastructure/          # &quot;Infrastructure&quot; layer: implementation of interface from &quot;Application&quot; layer
    ├── repositories/
    │   ├── calibration_repository/
    │   │   ├── mock_repository.py     # implements in-memory
    │   │   ├── mongodb_repository.py  # implements mongodb
    │   │   └── postgres_repository.py # implements postgres
    │   └── orm_models.py       # sqlalchemy-specific orm &lt;-&gt; system entity mapper
    └── services/
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../PROJECT/" class="btn btn-neutral float-left" title="Project"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../DEVELOPER/" class="btn btn-neutral float-right" title="DEVELOPER">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../PROJECT/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../DEVELOPER/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
